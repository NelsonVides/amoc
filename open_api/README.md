## migration from [cowboy-swagger](https://github.com/inaka/cowboy_swagger) to [openapi generator](https://openapi-generator.tech/)
### amoc-openapi.yaml generation:
* download `swagger.json` file generated by [cowboy-swagger](https://github.com/inaka/cowboy_swagger) from `Amoc`:
```bash
curl http://localhost:4000/api-docs/swagger.json -o amoc-swagger.json
```
* open [Swagger Editor](http://editor.swagger.io/) and import downloaded `amoc-swagger.json` file (`File` -> `Import file`)
* convert it into OpenAPI format (`Edit` -> `Convert to OpenAPI 3`)
* add mandatory `version` property in the `info` section
* apply auto-formatting (`Edit` -> `Convert to YAML`)
* save the yaml file (`File`->`Save As YAML`) as `amoc-openapi.yaml`
### validation of the YAML spec:
```bash
alias openapi-generator='docker run --rm -v "${PWD}:/local" openapitools/openapi-generator-cli:v4.3.1'
openapi-generator validate -i /local/amoc-openapi.yaml
```
### erlang-server stubs generation:
```bash
openapi-generator generate -g erlang-server \
  --additional-properties=packageName=amoc_rest \
  -i /local/amoc-openapi.yaml -o /local/amoc_rest
```
the full list of configuration options for the `erlang-server` generator can be found here:
* https://openapi-generator.tech/docs/generators/erlang-server/
### removal of cowboy-swagger REST API implementation
* remove related source code (`../src/rest_api`)
* remove unneeded dependencies from `../rebar.config`
* regenerate `../rebar.lock`
* remove unneeded dependencies from `../src/amoc.app.src`
* remove initialisation of the REST API server from the `amoc_app:start/2` interface
### integration of generated erlang-server
* copy OpenAPI JSON definition (`./amoc_rest/priv/openapi.json`) into the `../priv/` directory
* copy the source code from `./amoc_rest/src/` into `../src/rest_api/amoc_rest` directory (only `*.erl` files)
* copy required dependencies from `./amoc_rest/rebar.config` to `../rebar.config`
* regenerate `../rebar.lock`
* add required dependencies at `../src/amoc.app.src`
* add `amoc_rest_server:start/2` call at `amoc` application startup
### integration of swagger-ui
* download the ["dist"](https://github.com/swagger-api/swagger-ui/tree/v3.25.3/dist) version of swagger-ui.
you can use [DownGit](https://downgit.github.io/) service to download just one directory from the repo.
here is the direct [link](https://downgit.github.io/#/home?url=https://github.com/swagger-api/swagger-ui/tree/v3.25.3/dist&fileName=swagger_ui&rootDirectory=swagger_ui)
* copy downloaded `swagger-ui` files into `../priv/swagger_ui` folder
* change default `swagger-ui` url to `../openapi.json` in `../priv/swagger_ui/index.html`
* use [raw.githack.com](https://raw.githack.com/) service to check that url change works as expected.
you can use this [link](https://rawcdn.githack.com/esl/amoc/0c34238/priv/swagger_ui/index.html).
* before updating `swagger-ui` you can always [test it](https://raw.githack.com/swagger-api/swagger-ui/master/dist/index.html?url=https://raw.githubusercontent.com/esl/amoc/0c34238/priv/openapi.json)
* add static `cowboy_static` routing required for `swagger-ui`.
notice changes in the generated code `../src/rest_api/amoc_rest/amoc_rest_server.erl`,
this issue is already [reported](https://github.com/OpenAPITools/openapi-generator/issues/6354) to
the `openapi generator`
### implementation of the Amoc REST API
* run `make dialyzer`, identify and fix minor issues with function specs in the generated code.

        TODO: this should be also reported to the openapi generator project

* create custom `logic handler` module
* implement HTTP `GET` methods:
  * extract and adjust source code from `cowboy-swagger` based implementation
  * update schemas for `GET` methods
* implement `/upload` method:
  * update OpenAPI definition for `/upload` method
  * implement `/upload` method (based on `cowboy-swagger` implementation). notice the changes in generated code

        TODO: this should be also reported to the openapi generator project

  * allow `application/octet-stream` content type for the `/upload` method, it has a
nice file selection menu in the `swagger-ui`
  * update `/upload` description
* implement scenario execution REST API:
  * update OpenAPI definition
  * implement scenario execution interface. notice the changes in generated code

        TODO: this should be also reported to the openapi generator project

* run `make xref`, identify and fix minor issues:
  * `amoc_rest_auth:get_api_key/3` calls undefined function `openapi_utils:to_header/1` - there is no `openapi_utils`
module, `amoc_rest_utils` must be used instead.

        TODO: this should be also reported to the openapi generator project

  * as we do not use REST API authentication, `amoc_rest_auth` module isn't used at all. so it can be safely removed.
* run `make test`, identify and fix all the issues with tests:
    * fix mocking and `undefined functions` issues
    * use named json schemas in `amoc-openapi.yaml`
